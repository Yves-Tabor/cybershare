<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberShare - Vulnerability Scanner</title>
    <link rel="stylesheet" href="/src/main.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyber-dark': '#0A0E1A',
                        'cyber-darker': '#060911',
                        'cyber-blue': '#00D9FF',
                        'cyber-purple': '#8B5CF6',
                        'cyber-green': '#10B981',
                        'cyber-red': '#EF4444',
                        'cyber-yellow': '#F59E0B',
                    },
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'monospace'],
                        'sans': ['Sora', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes scan {
            0%, 100% { transform: translateY(0); opacity: 0.3; }
            50% { transform: translateY(10px); opacity: 1; }
        }
        .scan-animation { animation: scan 2s ease-in-out infinite; }
        
        /* Sidebar Transitions */
        #commentSidebar { transition: transform 0.3s ease-in-out; }
        
        /* BW Body Styling */
        .bw-container { background-color: #000; color: #fff; border: 1px solid #fff; }
        .bw-input { background: #000; border: 1px solid #fff; color: #fff; }
        .bw-input:focus { background: #fff; color: #000; outline: none; }
        .bw-button { border: 1px solid #fff; color: #fff; background: transparent; transition: all 0.2s; }
        .bw-button:hover:not(:disabled) { background: #fff; color: #000; }
        .bw-button:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Notification Dot */
        #notif-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            background-color: #EF4444;
            border-radius: 50%;
            border: 2px solid #0A0E1A;
            display: none;
        }

        /* Custom Scrollbar */
        #commentList::-webkit-scrollbar {
            width: 6px;
        }
        #commentList::-webkit-scrollbar-track {
            background: #000;
            border: 1px solid #333;
        }
        #commentList::-webkit-scrollbar-thumb {
            background: #fff;
            border-radius: 3px;
        }
        #commentList::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }
    </style>
</head>
<body class="bg-black text-gray-100 font-sans overflow-x-hidden">

    <nav class="bg-[#0A0B0D] backdrop-blur-xl border-b border-white/5 sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto px-6">
            <div class="hidden xl:flex items-center justify-between h-20">
                <div class="flex items-center space-x-8">
                    <div class="flex flex-col border-r border-white/10 pr-8 cursor-pointer hover:bg-white/5 px-2 py-1 rounded transition-all" onclick="toggleUserModal()">
                        <span class="text-[10px] font-mono text-gray-500 uppercase tracking-widest">User</span>
                        <span id="currentUserDisplay" class="text-gray-500 font-semibold text-sm uppercase">THIS_USER</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-white to-black rounded flex items-center justify-center shadow-[0_0_4px_white]">
                            <span class="text-white font-bold text-xs">CS</span>
                        </div>
                        <span class="font-bold text-xl font-mono tracking-tighter uppercase">Cyber<span class="text-white">Share</span></span>
                    </div>
                </div>
                
                <div class="flex space-x-8 items-center">
                    <a href="home.html" class="text-gray-400 hover:text-white font-mono text-[12px] transition tracking-widest uppercase">HOME</a>
                    <a href="scanner.html" class="text-white font-mono text-[12px] transition tracking-widest uppercase text-cyber-blue">SCANNER</a>
                    <a href="resources.html" class="text-gray-400 hover:text-white font-mono text-[12px] transition tracking-widest uppercase">RESOURCES</a>
                    <button onclick="toggleModal('protocolModal')" class="text-gray-400 hover:text-white font-mono text-[12px] transition tracking-widest uppercase">Protocol</button>
                    <div class="h-6 w-[1px] bg-white/10 mx-2"></div>
                    
                    <button id="sidebarToggleBtn" onclick="toggleSidebar()" class="relative p-2 bg-white/5 border border-white/10 rounded-lg group transition-all hover:bg-white/10">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <div id="notif-dot"></div>
                    </button>

                    <button onclick="handleLogout()" class="px-4 py-2 bg-black border-2 border-white text-white hover:bg-gray-800 rounded-lg text-[10px] transition uppercase">Logout</button>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <div class="xl:hidden">
                <!-- Mobile Header -->
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <div class="hidden sm:flex flex-col cursor-pointer hover:bg-white/5 px-2 py-1 rounded transition-all" onclick="toggleUserModal()">
                            <span class="text-[10px] font-mono text-gray-500 uppercase tracking-widest">User</span>
                            <span id="currentUserDisplay" class="text-gray-500 font-semibold text-sm uppercase">THIS_USER</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-white to-black rounded flex items-center justify-center shadow-[0_0_4px_white]">
                                <span class="text-white font-bold text-[8px]">CS</span>
                            </div>
                            <span class="font-bold text-lg font-mono tracking-tighter uppercase">Cyber<span class="text-white">Share</span></span>
                        </div>
                    </div>
                    
                    <button onclick="toggleMobileMenu()" class="p-2 bg-white/5 border border-white/10 rounded-lg group transition-all hover:bg-white/10">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>

                <!-- Mobile Menu (Vertical) -->
                <div id="mobileMenu" class="hidden pb-4 space-y-3">
                    <div class="flex flex-col space-y-2">
                        <a href="home.html" class="text-white font-mono text-[12px] transition tracking-widest uppercase py-2 px-4 hover:bg-white/10 rounded">HOME</a>
                        <a href="scanner.html" class="text-cyber-blue font-mono text-[12px] transition tracking-widest uppercase py-2 px-4 hover:bg-white/10 rounded">SCANNER</a>
                        <a href="../resources.html" class="text-gray-400 hover:text-white font-mono text-[12px] transition tracking-widest uppercase py-2 px-4 hover:bg-white/10 rounded">RESOURCES</a>
                        <button onclick="toggleModal('protocolModal')" class="text-gray-400 hover:text-white font-mono text-[12px] transition tracking-widest uppercase py-2 px-4 hover:bg-white/10 rounded text-left">PROTOCOL</button>
                    </div>
                    
                    <div class="border-t border-white/10 pt-3 flex items-center justify-between">
                        <button id="sidebarToggleBtn" onclick="toggleSidebar()" class="relative p-2 bg-white/5 border border-white/10 rounded-lg group transition-all hover:bg-white/10">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                            </svg>
                            <div id="notif-dot"></div>
                        </button>

                        <button onclick="handleLogout()" class="px-4 py-2 bg-black border-2 border-white text-white hover:bg-gray-800 rounded-lg text-[10px] transition uppercase">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <aside id="commentSidebar" class="fixed right-0 top-20 h-[calc(100vh-5rem)] w-80 bg-black border-l border-white z-40 transform translate-x-full shadow-2xl">
        <div class="p-6 flex flex-col h-full">
            <h2 class="font-mono font-bold text-white mb-6 uppercase tracking-wider border-b border-white pb-2">Analysis Logs</h2>
            <div id="commentList" class="space-y-4 flex-1 overflow-y-auto max-h-[calc(100vh-10rem)]">
                <div class="p-3 border border-gray-700 rounded-lg">
                    <p class="text-[10px] text-gray-500 font-mono mb-1">System Initialization</p>
                    <p class="text-xs text-gray-400">Waiting for a link to scan ...</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="max-w-4xl mx-auto px-6 py-16">
        <div class="text-center mb-12">
            <h1 class="text-6xl font-bold mb-4 tracking-tighter lowercase">Vulnerability Audit</h1>
            <p class="text-gray-500 uppercase text-xs tracking-[0.4em]">Platform Security Layer</p>
        </div>

        <div class="bw-container p-10 bg-black rounded-xl">
            <form id="scanForm" class="space-y-8" onsubmit="handleScan(event)">
                <div>
                    <label class="block text-xs uppercase mb-4 tracking-widest text-gray-400 font-bold font-mono rounded-lg">Enter Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com" class="bw-input w-full p-5 text-lg rounded-lg" required>
                </div>

                <div class="flex items-start gap-4 p-5 border border-dashed border-gray-700 rounded-lg">
                    <input type="checkbox" id="ackCheck" class="w-5 h-5 mt-1 accent-white rounded" onchange="toggleButton()">
                    <div class="flex-1">
                        <label for="ackCheck" class="text-[11px] leading-relaxed text-gray-400 uppercase rounded-lg">
                            I acknowledge I have authorization to conduct a security scan including header analysis, fingerprinting, and disclosure checks...
                        </label>
                        <button type="button" onclick="toggleLegalModal()" class="text-[10px] text-white underline ml-2 uppercase">
                            Read More
                        </button>
                    </div>
                </div>

                <button type="submit" id="scanBtn" disabled class="bw-button w-full py-5 font-bold lowercase tracking-widest rounded-lg">
                    Start scanning
                </button>
            </form>
            <div id="progressContainer" class="hidden mt-8 w-full bg-gray-900 h-1">
                <div id="progressBar" class="bg-white h-full transition-all duration-500 w-0"></div>
            </div>
        </div>

        <div id="scanStatus" class="mt-8 text-center text-[10px] font-mono text-gray-600 uppercase tracking-widest">
            Waiting for command...
        </div>

        <!-- Download Report Button (Hidden by default) -->
        <div id="downloadSection" class="hidden mt-6 text-center">
            <button id="downloadBtn" onclick="downloadReport()" class="px-6 py-3 bg-white text-black hover:bg-black border-2 border-white hover:text-white transition-all text-md lowercase tracking-widest rounded-md">
                 Download PDF Report
            </button>
        </div>
    </main>

    <div id="protocolModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleModal('protocolModal')"></div>
        <div class="bg-black border-2 border-white w-full max-w-md rounded-xl p-8 relative shadow-2xl">
            <h2 class="font-bold text-white mb-6 text-xl tracking-tighter lowercase">System Protocols</h2>
            <ul class="space-y-4 font-mono text-xs text-gray-400">
                <li><span class="text-white">01.</span> NO SPAM: System will slow you down when broadcasting excessively</li>
                <li><span class="text-white">02.</span> INTEGRITY: Dangerous code is cleaned out immediately</li>
                <li><span class="text-white">03.</span> UPLOADS: Posts are persistent and visible to all users</li>
                <li><span class="text-white">04.</span> COMMENTS: All replies are transmitted in real-time</li>
                <li><span class="text-white">05.</span> REPORTS: Do not scan a link you don't have authorization to scan</li>
                <li><span class="text-white">05.</span> SCANNER: To check scanning results click on notification icon at the header</li>
                <li><span class="text-white">06.</span> PRIVACY: Your identity is protected at all times</li>
                <li><span class="text-white">07.</span> SUPPORT: <a href="mailto:walvesoutis@gmail.com" class="text-white underline">Contact us</a> if you encounter any issues</li>
            </ul>
            <button onclick="toggleModal('protocolModal')" class="mt-8 w-full py-3 border border-white text-white hover:bg-gray-800 transition-all text-[14px] lowercase tracking-tighter">Acknowledge</button>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleLogoutModal()"></div>
        <div class="bg-black border-2 border-white w-full max-w-md rounded-xl p-8 relative shadow-2xl">
            <h2 class="font-bold text-white mb-6 text-xl tracking-tighter lowercase">Confirm Logout</h2>
            <p class="text-gray-400 mb-8 text-sm">Are you sure you want to leave the session? You will need to login again to access the platform.</p>
            <div class="flex gap-4">
                <button onclick="toggleLogoutModal()" class="flex-1 py-3 border border-white text-white hover:bg-gray-800 transition-all text-[14px] lowercase tracking-tighter">Cancel</button>
                <button onclick="confirmLogout()" class="flex-1 py-3 bg-red-600 text-white hover:bg-red-700 transition-all text-[14px] lowercase tracking-tighter">Logout</button>
            </div>
        </div>
    </div>

    <!-- Legal Disclaimer Modal -->
    <div id="legalModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleLegalModal()"></div>
        <div class="bg-black border-2 border-white w-full max-w-4xl max-h-[80vh] overflow-y-auto rounded-xl p-8 relative shadow-2xl">
            <h2 class="font-bold text-white mb-6 text-xl tracking-tighter uppercase">Legal Disclaimer & Usage Terms</h2>
            
            <div class="space-y-6 text-gray-300 font-mono text-sm">
                <div class="border-l-4 border-red-500 pl-4">
                    <h3 class="text-white font-bold mb-2 uppercase">WARNING: LEGAL CONSEQUENCES APPLY</h3>
                    <p>Unauthorized use of this security scanner may result in severe legal penalties including criminal charges and civil liability.</p>
                </div>

                <div>
                    <h3 class="text-white font-bold mb-2 uppercase">1. Authorized Use Only</h3>
                    <p>You must be the legal owner or have explicit written permission from the website owner before scanning. Scanning websites you do not own is illegal and constitutes unauthorized access under computer crime laws.</p>
                </div>

                <div>
                    <h3 class="text-white font-bold mb-2 uppercase">2. User Fingerprinting & Tracking</h3>
                    <p class="text-yellow-400">This system maintains permanent records including:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-400">
                        <li>User IP address and geolocation data</li>
                        <li>Browser fingerprint and device information</li>
                        <li>Email address and account credentials</li>
                        <li>Timestamp and duration of all scans</li>
                        <li>Target URLs and scan results</li>
                        <li>Session ID and unique user identifier</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold mb-2 uppercase">3. Legal Consequences</h3>
                    <p class="text-red-400">Violators may face:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-400">
                        <li>Criminal charges under Computer Fraud and Abuse Act (CFAA)</li>
                        <li>Civil lawsuits for damages and unauthorized access</li>
                        <li>Immediate and permanent account termination</li>
                        <li>Reporting to law enforcement agencies</li>
                        <li>Legal action for damages up to $250,000 per violation</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold mb-2 uppercase">4. Permitted Use Cases</h3>
                    <p class="text-green-400">You may ONLY scan:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-400">
                        <li>Websites you legally own</li>
                        <li>Websites for which you have explicit permission to test</li>
                        <li>Your own development and testing environments</li>
                        <li>Websites explicitly designated for security testing</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold mb-2 uppercase">5. Data Retention & Sharing</h3>
                    <p>All scan data is permanently stored and may be shared with:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-400">
                        <li>Law enforcement agencies upon request</li>
                        <li>Website owners for verification purposes</li>
                        <li>Legal authorities during investigations</li>
                        <li>Cybersecurity incident response teams</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold mb-2 uppercase">6. No Warranty</h3>
                    <p>This scanner is provided "as-is" without warranty. Results are for educational purposes only. Professional security assessments should be conducted by certified professionals.</p>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <p class="text-xs text-gray-500">By clicking "I Understand & Accept", you acknowledge that you have read, understood, and agree to be legally bound by these terms. You confirm that you have legal authority to scan the target website and accept full legal responsibility for your actions.</p>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="toggleLegalModal()" class="flex-1 py-3 border border-white text-white hover:bg-gray-800 transition-all text-[14px] lowercase tracking-tighter">Cancel</button>
                <button onclick="acceptLegalTerms()" class="flex-1 py-3 bg-red-600 text-white hover:bg-red-700 transition-all text-[14px] lowercase tracking-tighter">I Understand & Accept</button>
            </div>
        </div>
    </div>

    <!-- User Information Modal -->
    <div id="userModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleUserModal()"></div>
        <div class="bg-black border-2 border-white w-full max-w-md rounded-xl p-8 relative shadow-2xl">
            <h2 class="font-bold text-white mb-6 text-xl tracking-tighter lowercase">User Information</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-mono text-gray-500 uppercase tracking-widest mb-2">Display Name</label>
                    <input type="text" id="displayName" class="w-full bg-black border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-white font-mono text-sm" placeholder="Enter display name">
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-gray-500 uppercase tracking-widest mb-2">Email Address</label>
                    <input type="email" id="userEmail" class="w-full bg-black border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-white font-mono text-sm" readonly>
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-gray-500 uppercase tracking-widest mb-2">Account Status</label>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-green-500 font-mono text-sm">VERIFIED USER</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="toggleUserModal()" class="flex-1 py-3 border border-white text-white hover:bg-gray-800 transition-all text-[14px] lowercase tracking-tighter">Cancel</button>
                <button onclick="updateUserInfo()" class="flex-1 py-3 bg-cyber-blue text-white hover:bg-cyber-blue/80 transition-all text-[14px] lowercase tracking-tighter">Update</button>
            </div>
        </div>
    </div>

    <script>
        function toggleButton() {
            const check = document.getElementById('ackCheck');
            const btn = document.getElementById('scanBtn');
            btn.disabled = !check.checked;
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('commentSidebar');
            const redPoint = document.getElementById('notif-dot');
            sidebar.classList.toggle('translate-x-full');
            
            // Per Instructions: Red point disappears only when the icon is clicked
            if (!sidebar.classList.contains('translate-x-full')) {
                redPoint.style.display = 'none';
            }
        }

        function addComment(title, status, recommendation) {
            const list = document.getElementById('commentList');
            const redPoint = document.getElementById('notif-dot');
            const sidebar = document.getElementById('commentSidebar');
            
            const commentDiv = document.createElement('div');
            commentDiv.className = "p-3 border border-white rounded-lg mb-3 animate-pulse";
            commentDiv.innerHTML = `
                <p class="text-[10px] text-white font-bold font-mono uppercase">${title} [${status}]</p>
                <p class="text-[11px] text-gray-400 mt-1">REC: ${recommendation}</p>
            `;
            list.prepend(commentDiv);
            
            // Per Instructions: Show red point until clicked
            if (sidebar.classList.contains('translate-x-full')) {
                redPoint.style.display = 'block';
            }
        }

        // Global variable to store scan results
        let lastScanResults = null;
        let lastScanUrl = null;
        let lastScanTimestamp = null;
        
        // Session management
        let sessionId = localStorage.getItem('cybershare_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('cybershare_session_id', sessionId);
        }

        async function handleScan(e) {
            e.preventDefault();
            const url = document.getElementById('urlInput').value;
            const status = document.getElementById('scanStatus');
            const progress = document.getElementById('progressBar');
            const progCont = document.getElementById('progressContainer');
            const scanBtn = document.getElementById('scanBtn');

            progCont.classList.remove('hidden');
            status.innerText = "Initializing scan for: " + url.toUpperCase();
            scanBtn.disabled = true;
            scanBtn.textContent = "Scanning...";

            try {
                // Check legal terms acceptance
                const legalAccepted = localStorage.getItem('legalTermsAccepted');
                const legalVersion = localStorage.getItem('legalTermsVersion');
                
                if (!legalAccepted || legalVersion !== '1.0') {
                    alert('You must accept the legal terms before scanning. Please click "Read More" and accept the terms.');
                    toggleLegalModal();
                    return;
                }

                // Call backend API
                const response = await fetch('http://localhost:3001/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': sessionId,
                        'X-Legal-Accepted': legalAccepted,
                        'X-Legal-Version': legalVersion
                    },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Scan failed');
                }

                // Clear previous results
                document.getElementById('commentList').innerHTML = '';

                // Display results
                const scanSteps = data.results;
                
                for (let i = 0; i < scanSteps.length; i++) {
                    await new Promise(r => setTimeout(r, 500));
                    const step = scanSteps[i];
                    
                    let statusClass = step.status.toLowerCase();
                    if (statusClass === 'pass') statusClass = 'success';
                    if (statusClass === 'fail') statusClass = 'danger';
                    if (statusClass === 'warn') statusClass = 'warning';
                    
                    addComment(step.title, step.status.toUpperCase(), step.recommendation);
                    progress.style.width = ((i + 1) / scanSteps.length * 100) + "%";
                }

                // Store scan results for download
                lastScanResults = scanSteps;
                lastScanUrl = url;
                lastScanTimestamp = new Date().toISOString();

                // Show download button
                document.getElementById('downloadSection').classList.remove('hidden');

                status.innerText = `Scan Complete! ${scanSteps.length} security checks performed.`;

            } catch (error) {
                console.error('Scan error:', error);
                status.innerText = `Scan Failed: ${error.message}`;
                addComment('SCAN ERROR', 'FAIL', error.message);
            } finally {
                scanBtn.disabled = false;
                scanBtn.textContent = "Start Scanning";
            }
        }

        // Download PDF Report Function
        async function downloadReport() {
            if (!lastScanResults || !lastScanUrl) {
                alert('No scan results available. Please run a scan first.');
                return;
            }

            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Generating PDF...';

            try {
                const response = await fetch('http://localhost:3001/api/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': sessionId
                    },
                    body: JSON.stringify({
                        results: lastScanResults,
                        url: lastScanUrl,
                        timestamp: lastScanTimestamp
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }

                // Create download link
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `cybershare-scan-report-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);

                console.log('PDF report downloaded successfully');

            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download report. Please try again.');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download PDF Report';
            }
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        
        function toggleLegalModal() {
            const modal = document.getElementById('legalModal');
            modal.classList.toggle('hidden');
        }

        function acceptLegalTerms() {
            // Store legal acceptance timestamp
            localStorage.setItem('legalTermsAccepted', Date.now().toString());
            localStorage.setItem('legalTermsVersion', '1.0');
            
            // Close modal
            toggleLegalModal();
            
            // Show confirmation
            const status = document.getElementById('scanStatus');
            status.innerText = 'Legal terms accepted. You may now proceed with scanning.';
            
            console.log('Legal terms accepted by user:', localStorage.getItem('username') || 'Anonymous');
        }

        // Check if legal terms have been accepted
        function checkLegalAcceptance() {
            const accepted = localStorage.getItem('legalTermsAccepted');
            const version = localStorage.getItem('legalTermsVersion');
            
            // If terms haven't been accepted or version is different, show modal
            if (!accepted || version !== '1.0') {
                // Auto-show legal modal on page load
                setTimeout(() => {
                    toggleLegalModal();
                }, 1000);
            }
        }
        
        function handleLogout() {
            toggleLogoutModal();
        }

        function toggleLogoutModal() {
            const modal = document.getElementById('logoutModal');
            modal.classList.toggle('hidden');
        }

        async function confirmLogout() {
            try {
                // Firebase auth logout
                const auth = getAuth(initializeApp({
                    apiKey: "AIzaSyCiCPymL7UVi1PWRDQVyRYNn2z9HNjC1V0",
                    authDomain: "cybershare-001.firebaseapp.com",
                    projectId: "cybershare-001",
                    storageBucket: "cybershare-001.firebasestorage.app",
                    messagingSenderId: "300595987814",
                    appId: "1:300595987814:web:f1a81e68926cba2553b4a7"
                }));
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (e) {
                console.error("Logout failed:", e);
                alert("Logout failed. Please try again.");
            }
        }

        // User modal functions
        function toggleUserModal() {
            const modal = document.getElementById('userModal');
            modal.classList.toggle('hidden');
            

            if (!modal.classList.contains('hidden')) {
                const username = localStorage.getItem('username') || 'ADMIN_NODE';
                const userEmail = localStorage.getItem('userEmail') || '';
                document.getElementById('displayName').value = username;
                document.getElementById('userEmail').value = userEmail;
            }
        }

        function updateUserInfo() {
            const newDisplayName = document.getElementById('displayName').value.trim();
            
            if (!newDisplayName) {
                alert("Display name cannot be empty");
                return;
            }
            
            try {
                // Update localStorage
                const currentUser = newDisplayName.toUpperCase().replace(/[^A-Z0-9]/g, '_');
                localStorage.setItem('username', currentUser);
                
                // Update UI displays
                document.getElementById('currentUserDisplay').textContent = currentUser;
                
                // Update mobile display if exists
                const mobileDisplay = document.getElementById('currentUserDisplayMobile');
                if (mobileDisplay) mobileDisplay.textContent = currentUser;
                
                
                toggleUserModal();
                
                console.log("User information updated successfully");
                
            } catch (e) {
                console.error("Failed to update user information:", e);
                alert("Failed to update user information. Please try again.");
            }
        }

        // Storage event listener to sync user information updates
        window.addEventListener('storage', (e) => {
            if (e.key === 'username') {
                const newUsername = e.newValue || localStorage.getItem('username') || 'ADMIN_NODE';
                document.getElementById('currentUserDisplay').textContent = newUsername;
                const mobileDisplay = document.getElementById('currentUserDisplayMobile');
                if (mobileDisplay) mobileDisplay.textContent = newUsername;
                console.log(' Username synced across pages:', newUsername);
            }
            if (e.key === 'userEmail') {
                console.log(' User email synced across pages:', e.newValue);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const user = localStorage.getItem('username') || 'ADMIN_NODE';
            document.getElementById('currentUserDisplay').textContent = user;
            
            // Check legal terms acceptance
            checkLegalAcceptance();
        });
    </script>

    <script type="module">
        import { 
            app, 
            auth, 
            onAuthStateChanged 
        } from './src/firebase.js';

        // Check authentication state and verification
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Check email verification
                if (!user.emailVerified) {
                    console.log("Unverified user detected, logging out...");
                    auth.signOut();
                    localStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }
                
                // Check if user has custom display name in localStorage
                const storedUsername = localStorage.getItem('username');
                if (storedUsername && storedUsername !== 'ADMIN_NODE') {
                    // Use the custom display name
                    document.getElementById('currentUserDisplay').textContent = storedUsername;
                    console.log('Using custom display name:', storedUsername);
                    
                    // Update mobile display if exists
                    const mobileDisplay = document.getElementById('currentUserDisplayMobile');
                    if (mobileDisplay) mobileDisplay.textContent = storedUsername;
                } else {
                    // Use email-based username as fallback
                    const username = user.email.split('@')[0].toUpperCase().replace(/[^A-Z0-9]/g, '_');
                    localStorage.setItem('username', username);
                    document.getElementById('currentUserDisplay').textContent = username;
                    console.log('Using email-based username:', username);
                    
                    // Update mobile display if exists
                    const mobileDisplay = document.getElementById('currentUserDisplayMobile');
                    if (mobileDisplay) mobileDisplay.textContent = username;
                }
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>